---
title: "deleted code"
author: "Carlo Greß"
date: "2024-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Visualising the final RBS blocks, coloring based on whether the block is occupied or not

```{r}
# Transforming the dataframe into an sf object for plotting 
berlin_final_sf <- st_as_sf(berlin_final, crs = utm_crs_germany)

# Plot the map using ggplot2
ggplot() +
  geom_sf(data = filter(berlin_final_sf, ewk != "unbewohnt"), aes(fill = "Inhabited"), size = 0.5, alpha = 0.5) +
  geom_sf(data = filter(berlin_final_sf, ewk == "unbewohnt"), aes(fill = "Unoccupied"), size = 0.5, alpha = 0.5) +
  scale_fill_manual(values = c("Unoccupied" = "red", "Inhabited" = "blue")) +
  theme_void() + # Remove axes
  theme(legend.position = "right", legend.title = element_blank(), legend.text = element_text(size = 10))

# If needed, save the plot to a file
ggsave("final_figures/berlin_blocks_map.png", width = 15, height = 15, dpi = 300)

```

```{r}
btw_21_sf |> 
  filter(Country == "Berlin") |> 
  ggplot() +
  geom_sf(aes(fill = deviation), color = "0.8", size = 0.8) +
  scale_fill_distiller(palette = "RdBu", name = "Deviation (in %)", limits = c(min(btw_21_sf$deviation, na.rm = TRUE), max(btw_21_sf$deviation, na.rm = TRUE))) +
  theme_void() +
  theme(plot.title = element_text(size = 16),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)) +
  theme(legend.position = "right")

# Display the plot
ggsave("final_figures/population_deviation_map_berlin.png", width = 12, height = 8, dpi = 300)
```

Berlin map highlighting problematic constituencies and labels them
```{r}

berlin_non_residents <- btw_21_sf |>  
  filter(Country == "Berlin") 

ggplot(data = berlin_non_residents) +
  geom_sf(data = berlin_non_residents |> filter(deviation25_nr == 0), fill = "grey", color = NA, size = 0.1) +
  geom_sf(data = berlin_non_residents |> filter(deviation25_nr == 1), aes(fill = deviation_non_residents), color = NA, size = 0.1) +
  scale_fill_distiller(palette = "RdBu", name = "Deviation (in per cent)", 
                       limits = c(min(berlin_non_residents$deviation_non_residents, na.rm = TRUE), max(berlin_non_residents$deviation_non_residents, na.rm = TRUE))) +
  theme_void() +
  theme(plot.title = element_text(size = 16),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.position = "right")
```


Next, we are creating a plot that shows the foreigner's percentage per constituency. 

```{r}
ggplot(data = btw_21_sf) +
  geom_sf(aes(fill = ForeignersPercentage), color = NA) +
  scale_fill_viridis_c(option = "plasma", name = "Foreigners Percentage") +
  theme_void() +
  theme(plot.title = element_text(size = 14),
        plot.subtitle = element_text(size = 10),
        legend.position = "right")

ggsave("final_figures/foreigners_percentage_annotated.png", width = 12, height = 8, dpi = 300)
```

```{r}
berlin_final <- st_as_sf(berlin_final, crs = utm_crs_germany)

ggplot(data = berlin_final) +
  geom_sf(aes(fill = foreigners_share), color = NA, na.value = "lightgrey") +
  scale_fill_viridis_c(option = "C", name = "Foreigners Share", na.value = "lightgrey", 
                       limits = c(NA, NA), oob = scales::squish) +
  theme_void() +
  theme(legend.position = "right")
```

Since this figure is hard to read because blocks are small, let's create a faceted plot (one for each constituency):

```{r}

# Function to create plot for each WKR_NAME
plot_district <- function(data, district_name) {
  data |>
    filter(WKR_NAME == district_name) |>
    ggplot() +
    geom_sf(aes(fill = foreigners_share), color = NA, na.value = "grey") +
    scale_fill_viridis_c(name = "Foreigners Share", na.value = "grey", limits = c(NA, NA), oob = scales::squish) +
    labs(title = district_name) +
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5, size = 10), legend.position = "none")
}

# Apply the function to each district
district_names <- unique(berlin_final$WKR_NAME)
plots <- lapply(district_names, function(name) plot_district(berlin_final, name))

# Combine the plots
combined_plot <- do.call(grid.arrange, c(plots, ncol = 2))

ggsave("berlin_districts_combined_plot.png", combined_plot, width = 40, height = 60, units = "cm")
```

Grouping the block data on state constituency level and preserving the federal constituency IDs. 
```{r}
awk_to_wkr <- berlin_final |>
  group_by(AWK, WKR_NR) |>
  summarise(WKR_NAME = first(WKR_NAME), .groups = 'drop')

print(awk_to_wkr)
```


```{r}
# Adding a pseudo-block with 0 population to berlin_redist and the original ah_wk objects to ensure that there is already a block assigned to a thirteenth district. This step is necessary to later be able to evaluate the differences in population per constituency. This is only available if the new number of districts matches the old number of districts. 

#new_row <- data.frame(
  #AWK = as.character("999"),
  #WKR_NR = as.character("999"),
  #WKR_NAME = "Berlin-New",
  #total_population = 0,
  #stringsAsFactors = FALSE  
#)

#berlin_redist <- bind_rows(berlin_redist, new_row)
#ah_wk <- bind_rows(ah_wk, new_row)
```

```{r}
areas = as.numeric(units::set_units(sf::st_area(berlin_redist$geometry), km^2))
plot(berlin_redist, fill = total_population / areas) + 
    scale_fill_viridis_c(name="Population density (people / sq. km)", 
                         trans="sqrt")
```

```{r}
png(filename = "final_figures/simulations.png", width = 12, height = 8, units = "in", res = 300)

# Generate the plot with specified parameters
redist.plot.plans(berlin_plans, draws=1:6, shp=berlin_redist)

# Close the PNG device to save the plot
dev.off()
```

# Tests
```{r}
group_frac(
  berlin_redist, foreign_population, total_population, berlin_plans)

redist.group.percent(plans, foreign_population, total_population, ncores = 1)
```

```{r}
std_dev_by_draw <- berlin_plans |>
  group_by(draw) |>
  summarise(std_dev = sd(total_pop, na.rm = TRUE)) |>
  arrange(std_dev) 

png(filename = "final_figures/simulations_deviations.png", width = 12, height = 8, units = "in", res = 300)

redist.plot.plans(std_dev_by_draw, draws = 1:5, shp = berlin_redist)

dev.off()
```


```{r}
btw_21_sf |> filter(Country == "Berlin") |> 
  ggplot() +
  geom_sf(aes(fill = as.factor(DistrictNo))) +  # Convert WKR_NR to a factor if it's numeric
  labs(title = "Map of Berlin colored by WKR_NR",
       fill = "DistrictNo") +
  theme_void() 

```

```{r}
library(patchwork)
redist.plot.plans(berlin_plans, draws = c("1"), shp = berlin_redist)
```


```{r}
berlin_plans = match_numbers(berlin_plans, berlin_redist$WKR_NAME)
print(berlin_plans)
```
```{r}
berlin_plans <- berlin_plans |> 
  mutate(district = district + 74)
```

```{r}
block_assignment <- as.data.frame(get_plans_matrix(berlin_plans))

awk <- ah_wk |> 
  select(AWK)


block_assignment <-  bind_cols(awk, block_assignment)

```

```{r}
block_assignment |> 
  select(AWK, V1, geometry) |> 
  plot()
```

```{r}
block_assignment <- block_assignment |>
  mutate(across(-AWK, ~ . + 74))
```

```{r}
if (!inherits(block_assignment, "sf")) {
  block_assignment <- st_as_sf(block_assignment)
}

# Plotting the blocks with colors based on the district assignment (V1)
ggplot(block_assignment) +
  geom_sf(aes(fill = as.factor(V1)), color = NA) + # Remove border color by setting color = NA
  scale_fill_viridis_d(name = "District") + # Use a discrete color scale for districts
  labs(title = "Block Assignment to Districts", subtitle = "Each color represents a different district") +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r}
original_assignment <- ah_wk |> 
  select(AWK, WKR_NR, WKR_NAME)

blocks_per_district <- original_assignment |>
  group_by(WKR_NAME) |>
  summarise(Blocks = toString(AWK), .groups = 'drop')

print(blocks_per_district)
```
```{r}
blocks_per_district <- block_assignment |>
  group_by(V1) |>
  summarise(Blocks = toString(AWK), .groups = 'drop')

print(blocks_per_district)
```
```{r}
library(dplyr)
library(stringr)

# Define a function to recode AWK values to district names
recode_awks_to_district <- function(awk) {
  case_when(
    awk %in% paste0("010", 1:7) ~ "Berlin-Mitte",
    awk %in% c(paste0("020", 1:6), "0309") ~ "Berlin-Friedrichshain-Kreuzberg – Prenzlauer Berg Ost",
    awk %in% paste0("030", 1:8) ~ "Berlin-Pankow",
    awk %in% paste0("040", 2:7) ~ "Berlin-Charlottenburg-Wilmersdorf",
    awk == "0401" | awk %in% paste0("050", 1:5) ~ "Berlin-Spandau – Charlottenburg Nord",
    awk %in% paste0("060", 1:7) ~ "Berlin-Steglitz-Zehlendorf",
    awk %in% paste0("070", 1:7) ~ "Berlin-Tempelhof-Schöneberg",
    awk %in% paste0("080", 1:6) ~ "Berlin-Neukölln",
    awk %in% paste0("090", 1:6) ~ "Berlin-Treptow-Köpenick",
    awk %in% paste0("100", 1:6) ~ "Berlin-Marzahn-Hellersdorf",
    awk %in% paste0("110", 1:6) ~ "Berlin-Lichtenberg",
    awk %in% paste0("120", 1:6) ~ "Berlin-Reinickendorf",
    TRUE ~ NA_character_  # Use NA as a placeholder for blocks not matching any set
  )
}

# Apply the function to create a new variable with district labels
block_assignment <- block_assignment |>
  mutate(district_label = recode_awks_to_district(AWK))

# Assign unique labels to NAs based on a sequence
new_blocks <- which(is.na(block_assignment$district_label))
block_assignment$district_label[new_blocks] <- paste0("new_block_", seq_along(new_blocks))

# Print V1 and the new variable next to each other for review
block_assignment |> select(AWK, V1, district_label)


```

### Figure(s) 7
```{r}
mean_abs_dev <- berlin_plans |>
  group_by(draw) |>
  summarise(mean_abs_dev = mean(abs(pop_deviation), na.rm = TRUE)) |>
  ungroup()  # This step is to remove the grouping structure for plotting

# Calculate the mean of mean absolute deviations
mean_value <- mean(mean_abs_dev$mean_abs_dev, na.rm = TRUE)

 ggplot(mean_abs_dev, aes(x = mean_abs_dev)) +
  geom_density(color = "black", fill = "blue", alpha = 0.7)  +
  labs(x = "Mean Absolute Deviation", y = "Frequency") +  # Simplified labels, no title
  theme_minimal() +  # Start with minimal theme
  theme(panel.grid.major = element_blank(),   # No major grid lines
        panel.grid.minor = element_blank(),   # No minor grid lines
        plot.title = element_blank(),         # No plot title
        axis.title.x = element_text(size = 12, face = "plain"),  # X axis label
        axis.title.y = element_text(size = 12, face = "plain"),  # Y axis label
        axis.text = element_text(size = 10),  # Text size for axis
        plot.background = element_blank(),    # Transparent background
        panel.border = element_rect(colour = "black", fill = NA, size = 1))
 
 ggsave("final_figures/distribution_density.png", width = 12, height = 8, dpi = 300)
```

### Figure 5

Figure 5 is an illustrative adjacency map of the 78 state constituencies

```{r}
plot(berlin_redist)

png(filename = "final_figures/berlin_redist_plot.png", width = 12, height = 8, units = "in", res = 300)
plot(berlin_redist)
dev.off()
```